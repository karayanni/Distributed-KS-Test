from matplotlib.ticker import FuncFormatter
import time
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
from queue_consumer_server.sqs_server import RedisHandler, SQSServer


def plt_server_runtimes(phase_2_times, total_run_digest_times, total_run_streaming_times, figure_name='figure'):
    # we want to add phase 2 as a common phase, and then the total runtimes for the two methods
    keys_digest, values_digest = zip(*total_run_digest_times.items())
    keys_streaming, values_streaming = zip(*total_run_streaming_times.items())
    keys2, values2 = zip(*phase_2_times.items())
    # plt.plot(keys2, values2, label='Computing KS', linestyle='dotted')

    plt.plot(keys_digest, values_digest, label='T-Digest-Merge')
    plt.plot(keys_streaming, values_streaming, label='T-Digest-Stream')

    # Add labels, title, and legend
    plt.xlabel('Aggregation  Size (Millions)', fontsize=20)
    plt.ylabel('Runtime (Seconds)', fontsize=20)
    plt.legend(fontsize=16)
    plt.xticks(fontsize=16)  # Set the x-axis labels
    plt.yticks(fontsize=16)


    # Show the plot
    plt.savefig(f'experiment_results/figures/{figure_name}.pdf', format='pdf', bbox_inches='tight')
    plt.show()
    plt.close()


if __name__ == '__main__':
    # these are the times from phase 1 if needed (different run so not 100% the same as the total below but with support=10)
    dist_aggregation_times_per_server_batch_size = {
        100000: 0.43591976165771484,
        300000: 1.139289140701294,
        500000: 1.9853448867797852,
        700000: 2.753371000289917,
        900000: 3.776754140853882,
        1100000: 4.840729475021362,
        1300000: 5.444644451141357,
        1500000: 6.9106738567352295,
        1700000: 7.252806901931763,
        1900000: 8.845601797103882,
        2100000: 9.011133909225464,
        2300000: 9.480106353759766,
        2500000: 10.439670324325562,
        2700000: 13.89718508720398,
        2900000: 12.344047784805298,
        3100000: 14.324902057647705,
        3300000: 15.45670747756958,
        3500000: 16.834339141845703,
        3700000: 16.096210956573486,
        3900000: 17.731830596923828,
        4100000: 17.62657070159912,
        4300000: 17.388505935668945,
        4500000: 18.09731936454773,
        4700000: 19.108684539794922,
        4900000: 20.529552698135376
    }
    streaming_aggregation_times_per_server_batch_size = {
        100000: 1.8577220439910889,
        300000: 5.328885078430176,
        500000: 9.407860040664673,
        700000: 12.907045602798462,
        900000: 17.72581171989441,
        1100000: 21.358651161193848,
        1300000: 26.3328959941864,
        1500000: 30.081721782684326,
        1700000: 33.748554944992065,
        1900000: 42.46195960044861,
        2100000: 41.01732277870178,
        2300000: 45.174458026885986,
        2500000: 48.34962844848633,
        2700000: 52.54234337806702,
        2900000: 64.4617874622345,
        3100000: 67.8900408744812,
        3300000: 69.93718814849854,
        3500000: 72.89471197128296,
        3700000: 79.35032057762146,
        3900000: 81.55633473396301,
        4100000: 88.5889503955841,
        4300000: 87.59393215179443,
        4500000: 91.1486656665802,
        4700000: 89.71583771705627,
        4900000: 91.92948412895203
    }

    server_phase_2_runtimes_with_support_10 = {
        100000: 98.02482218742371,
        200000: 98.39157729148864,
        300000: 97.92076163291931,
        400000: 97.22797470092773,
        500000: 96.72088060379028,
        600000: 98.15850152969361,
        700000: 99.00316979622487,
        800000: 97.52105279120315,
        900000: 99.2361530088555,
        1000000: 98.2862316798522,
        1100000: 99.3414648104344,
        1200000: 97.25393275126179,
        1300000: 99.58339629647611,
        1400000: 97.4081631371256,
        1500000: 98.94493410645529,
        1600000: 99.54395284883724,
        1700000: 98.61182631101663,
        1800000: 97.57789208532218,
        1900000: 99.03113951498605,
        2000000: 100.34024614024241,
        2100000: 97.79615623537754,
        2200000: 98.15079271843797,
        2300000: 99.76179894040791,
        2400000: 100.19653137231593,
        2500000: 97.87363236651944,
        2600000: 98.36396376214631,
        2700000: 97.68986917806963,
        2800000: 97.20109031541804,
        2900000: 98.01514923899032,
        3000000: 98.90981521767893,
        3100000: 99.79936875649754,
        3200000: 100.05412215839078,
        3300000: 99.284067516447,
        3400000: 99.25277204541547,
        3500000: 99.35894847978939,
        3600000: 98.9928408169407,
        3700000: 98.31188478596826,
        3800000: 98.92822455798487,
        3900000: 98.93824467790395,
        4000000: 98.45613882997179,
        4100000: 98.28043582341905,
        4200000: 99.3907856107427,
        4300000: 98.90886066246105,
        4400000: 99.17772255743492,
        4500000: 98.65303238779892,
        4600000: 99.64289227364796,
        4700000: 98.21474516286457,
        4800000: 97.38850907703636,
        4900000: 97.41446686359835,
        5000000: 98.43712047928281
    }
    total_run_times_dist_support_10 = {
        100000: 98.46074194908142, 300000: 99.0600507736206, 500000: 99.70622549057006, 700000: 101.75654079651478, 900000: 103.01290714970938, 1100000: 104.18219428545576, 1300000: 105.02804074761747, 1500000: 105.85560796319052, 1700000: 105.86463321294839, 1900000: 107.87674131208993, 2100000: 106.807290144603, 2300000: 109.24190529416768, 2500000: 108.313302690845, 2700000: 111.58705426527361, 2900000: 110.35919702379562, 3100000: 114.12427081414525, 3300000: 114.74077499401658, 3500000: 116.1932876216351, 3700000: 114.40809574254175, 3900000: 116.67007527482778, 4100000: 115.90700652501818, 4300000: 116.29736659813, 4500000: 116.75035175234665, 4700000: 117.3234297026595, 4900000: 117.94401956173373}
    total_run_times_streaming_support_10 = {
        100000: 99.8825442314148, 300000: 103.24964671134948, 500000: 106.12874064445495, 700000: 111.91021539902333, 900000: 116.9619647287499, 1100000: 120.70011597162825, 1300000: 125.91629229066251, 1500000: 129.02665588913962, 1700000: 132.36038125600868, 1900000: 138.49309911543466, 2100000: 138.81347901407932, 2300000: 144.9362569672939, 2500000: 146.22326081500577, 2700000: 150.23221255613663, 2900000: 162.47693670122482, 3100000: 167.68940963097873, 3300000: 169.22125566494555, 3500000: 173.25366045107234, 3700000: 177.66220536358972, 3900000: 181.49457941186697, 4100000: 185.86938621900316, 4300000: 187.50279281425549, 4500000: 189.80169805437913, 4700000: 189.93058287992085, 4900000: 193.3439509925504}

    plt_server_runtimes(server_phase_2_runtimes_with_support_10, total_run_times_dist_support_10, total_run_times_streaming_support_10, "Runtimes_server")
